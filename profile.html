<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PawPals - My Profile</title>
    <link rel="stylesheet" href="/dist/output.css">
    <script type="module" src="/js/firebase.js"></script>
    <script type="module" src="./js/loading.js"></script>
    
    <style>
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}

.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: hsl(34 91% 75%); /* Using theme primary color */
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
    <main class="container mx-auto max-w-4xl px-4 py-12">
        <div id="profile-content">
            <!-- Profile information will be dynamically inserted here -->
        </div>
    </main>

    <script type="module" src="./js/data.js"></script>
    <script type="module" src="./js/auth.js"></script>
    <script type="module" src="./js/layout.js"></script>
    <script type="module" src="./js/payment.js"></script> <!-- New import -->
    <script type="module">
        import { auth, db } from '/js/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { showLoadingOverlay, hideLoadingOverlay } from './js/loading.js';
        import { paymentModalHTML, setupPaymentModalListeners, openPaymentModal } from './js/payment.js'; // Import from payment.js
        import { showNotification } from './js/notification.js';

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '/login.html';
                return;
            }

            showLoadingOverlay();
            const profileContent = document.getElementById('profile-content');
            try {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                let userData = null;

                if (userSnap.exists()) {
                    userData = { uid: user.uid, ...userSnap.data() };
                } else {
                    console.error("User data not found in Firestore for UID:", user.uid);
                    userData = { uid: user.uid, email: user.email, name: user.email, role: 'user' }; // Fallback
                }

                const getInitials = (name) => {
                    if (!name) return 'U';
                    return name.split(' ').map((n) => n[0]).join('');
                };

                // Fetch user's orders
                const ordersQuery = query(collection(db, "orders"), where("userId", "==", user.uid));
                const ordersSnapshot = await getDocs(ordersQuery);
                const orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                let ordersHtml = '';
                if (orders.length > 0) {
                    ordersHtml = `
                        <div class="mt-8">
                            <h2 class="text-2xl font-semibold mb-4">Order History</h2>
                            <div class="border rounded-lg overflow-hidden overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Listing</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${orders.map(order => `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.listingName}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.listingPrice.toLocaleString()}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${order.paymentMethod}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${order.status}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(order.orderDate).toLocaleDateString()}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <a href="/order-detail.html?id=${order.id}" class="text-indigo-600 hover:text-indigo-900">View</a>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    ordersHtml = `<div class="mt-8"><h2 class="text-2xl font-semibold mb-4">Order History</h2><p class="text-muted-foreground">You have no orders yet.</p></div>`;
                }

                let cashappDetailsHtml = '';
                if (userData.cashappDetails) {
                    cashappDetailsHtml = `
                        <div class="mt-4">
                            <h3 class="text-xl font-semibold">Cash App Details</h3>
                            <p><strong>Transaction ID:</strong> ${userData.cashappDetails.transactionId || 'N/A'}</p>
                            ${userData.cashappDetails.proofUrl ? `
                                <p><strong>Proof:</strong> <a href="${userData.cashappDetails.proofUrl}" target="_blank" class="text-primary hover:underline">View Proof</a></p>
                                <img src="${userData.cashappDetails.proofUrl}" alt="Cash App Proof" class="w-32 h-32 object-cover rounded-md mt-2">
                            ` : '<p class="text-muted-foreground">No Cash App proof uploaded.</p>'}
                            <p><strong>Last Updated:</strong> ${new Date(userData.cashappDetails.lastUpdated).toLocaleString()}</p>
                        </div>
                    `;
                } else {
                    cashappDetailsHtml = '<div class="mt-4"><h3 class="text-xl font-semibold">Cash App Details</h3><p class="text-muted-foreground">No Cash App details saved.</p></div>';
                }

                if (userData && profileContent) {
                    profileContent.innerHTML = `
                    <div class="space-y-10">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-6">
                            <div class="h-24 w-24 border-2 border-primary rounded-full flex items-center justify-center bg-gray-200 text-3xl font-bold">
                                ${getInitials(userData.name)}
                            </div>
                            <div>
                            <h1 class="text-4xl font-bold font-headline">${userData.name}</h1>
                            <p class="text-lg text-muted-foreground">${userData.email}</p>
                            <span class="mt-2 inline-block rounded-full bg-secondary px-3 py-1 text-sm font-medium capitalize text-secondary-foreground">
                                ${userData.role}
                            </span>
                            </div>
                        </div>
        
                        <div class="grid gap-8 md:grid-cols-2">
                            <div class="border rounded-lg">
                                <div class="p-6 flex flex-row items-center gap-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8 text-primary"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                    <div>
                                        <h3 class="text-lg font-semibold">Personal Information</h3>
                                        <p class="text-sm text-muted-foreground">Manage your personal details.</p>
                                    </div>
                                </div>
                                <div class="p-6 pt-0">
                                    <button disabled class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-gray-200 text-gray-500 h-9 px-4 py-2">Edit Profile</button>
                                    <p class="text-xs text-muted-foreground mt-2">Editing coming soon.</p>
                                </div>
                            </div>
                            <div class="border rounded-lg">
                                <div class="p-6 flex flex-row items-center gap-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8 text-primary"><rect width="20" height="14" x="2" y="5" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>
                                    <div>
                                        <h3 class="text-lg font-semibold">Payment Details</h3>
                                        <p class="text-sm text-muted-foreground">Add or update your payment methods.</p>
                                    </div>
                                </div>
                                <div class="p-6 pt-0">
                                    <button id="add-payment-method-btn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2">Add Payment Method</button>
                                </div>
                            </div>
                        </div>
                        ${ordersHtml}
                        ${cashappDetailsHtml}
                    </div>
                    `;
                    // Inject payment modal HTML and setup listeners AFTER profile content is rendered
                    const paymentModalContainer = document.getElementById('payment-modal-container');
                    if (paymentModalContainer) {
                        paymentModalContainer.innerHTML = paymentModalHTML;
                    }
                    setupPaymentModalListeners(); // Call here, after elements are in DOM

                    // Manually attach listener for the button on this page
                    const addPaymentBtnOnProfile = document.getElementById('add-payment-method-btn');
                    if (addPaymentBtnOnProfile) {
                        addPaymentBtnOnProfile.addEventListener('click', openPaymentModal);
                    }

                    // Attach event listeners to delete buttons
                    document.querySelectorAll('.delete-order-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const orderIdToDelete = e.target.dataset.orderId;
                            handleDeleteOrder(orderIdToDelete);
                        });
                    });
                }
            } catch (error) {
                showNotification("Error loading profile data: " + error.message, true);
                profileContent.innerHTML = '<p class="text-red-500">Error loading profile data.</p>';
            } finally {
                hideLoadingOverlay();
            }
        });

        async function handleDeleteOrder(orderId) {
            showConfirmation("Are you sure you want to delete this order? This action cannot be undone.", async () => {
                showLoadingOverlay();
                try {
                    await deleteDoc(doc(db, "orders", orderId));
                    showNotification("Order deleted successfully!", false);
                    // Re-render the profile content to update the order list
                    // This is a bit heavy, but ensures the list is fresh.
                    // A more optimized approach would be to remove the row directly.
                    // For now, re-rendering the whole profile is simpler.
                    onAuthStateChanged(auth, () => {}); // Trigger re-render by re-running auth check
                } catch (error) {
                    console.error("Error deleting order: ", error);
                    showNotification("Error deleting order: " + error.message, true);
                } finally {
                    hideLoadingOverlay();
                }
            });
        }
    </script>
    <div id="payment-modal-container"></div> <!-- New container -->
    <!--Start of Tawk.to Script-->
    <script type="text/javascript">
    var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
    (function(){
    var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
    s1.async=true;
    s1.src='https://embed.tawk.to/695ca77a58fb05197cbe44bd/1je8usds4';
    s1.charset='UTF-8';
    s1.setAttribute('crossorigin','*');
    s0.parentNode.insertBefore(s1,s0);
    })();
    </script>
    <!--End of Tawk.to Script-->
</body>
</html>