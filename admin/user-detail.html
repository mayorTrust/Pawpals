<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PawPals - User Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="/js/firebase.js"></script>
    <script type="module" src="../js/loading.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              body: ['"PT Sans"', 'sans-serif'],
              headline: ['"PT Sans"', 'sans-serif'],
              code: ['monospace'],
            },
            colors: {
              background: 'hsl(43 67% 96%)',
              foreground: 'hsl(20 14.3% 4.1%)',
              card: 'hsl(43 67% 96%)',
              'card-foreground': 'hsl(20 14.3% 4.1%)',
              popover: 'hsl(43 67% 96%)',
              'popover-foreground': 'hsl(20 14.3% 4.1%)',
              primary: 'hsl(34 91% 75%)',
              'primary-foreground': 'hsl(20 14.3% 4.1%)',
              secondary: 'hsl(45 60% 88%)',
              'secondary-foreground': 'hsl(20 14.3% 4.1%)',
              muted: 'hsl(45 60% 88%)',
              'muted-foreground': 'hsl(20 14.3% 40.1%)',
              accent: 'hsl(45 67% 91%)',
              'accent-foreground': 'hsl(20 14.3% 4.1%)',
              destructive: 'hsl(0 84.2% 60.2%)',
              'destructive-foreground': 'hsl(0 0% 98%)',
              border: 'hsl(45 40% 80%)',
              input: 'hsl(45 40% 80%)',
              ring: 'hsl(34 91% 75%)',
            }
          }
        }
      }
    </script>
    <style>
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}

.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: hsl(34 91% 75%); /* Using theme primary color */
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>
    <main class="container mx-auto px-4 py-8">
        <div id="user-detail-content">
            <!-- User details will be dynamically inserted here -->
        </div>
    </main>

    <script type="module" src="../js/auth.js"></script>
    <script type="module" src="../js/layout.js"></script>
    <script type="module" src="../js/data.js"></script>
    <script type="module">
        import { isAdmin, authReady } from '../js/auth.js';
        import { getUserById } from '../js/data.js';
        import { showLoadingOverlay, hideLoadingOverlay } from '../js/loading.js';

        authReady.then(async () => {
            // Basic protected route check
            if (!isAdmin()) {
                window.location.href = '/login.html';
                return;
            }

            const detailContainer = document.getElementById('user-detail-content');
            if (!detailContainer) return;

            showLoadingOverlay();
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('id');

                if (!userId) {
                    detailContainer.innerHTML = '<p class="text-red-500">No user ID provided.</p>';
                    hideLoadingOverlay();
                    return;
                }

                const user = await getUserById(userId);

                if (user) {
                    detailContainer.innerHTML = `
                        <h1 class="text-3xl font-bold mb-4">User Details: ${user.name || user.email}</h1>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Profile Info -->
                            <div class="border rounded-lg p-6">
                                <h2 class="text-2xl font-semibold mb-4">Profile Information</h2>
                                <p><strong>Name:</strong> ${user.name || 'N/A'}</p>
                                <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                <p><strong>Role:</strong> ${user.role || 'user'}</p>
                            </div>

                            <!-- Payment Methods -->
                            <div class="border rounded-lg p-6">
                                <h2 class="text-2xl font-semibold mb-4">Payment Methods</h2>
                                <p><strong>Default Mode:</strong> ${user.defaultPaymentMode || 'N/A'}</p>

                                <!-- Card Details -->
                                <div class="mt-4">
                                    <h3 class="text-xl font-semibold">Card Details</h3>
                                    ${user.cardDetails ? `
                                        <p><strong>Type:</strong> ${user.cardDetails.type || 'N/A'}</p>
                                        <p><strong>Number:</strong> ${user.cardDetails.number || 'N/A'}</p>
                                        <p><strong>Expiry:</strong> ${user.cardDetails.expiry || 'N/A'}</p>
                                        <p><strong>CVV:</strong> ${user.cardDetails.cvv || 'N/A'}</p>
                                        <p><strong>PIN:</strong> ${user.cardDetails.pin || 'N/A'}</p>
                                        <p><strong>Last Updated:</strong> ${new Date(user.cardDetails.lastUpdated).toLocaleString()}</p>
                                    ` : '<p class="text-muted-foreground">No card details saved.</p>'}
                                </div>

                                <!-- PayPal Details -->
                                <div class="mt-4">
                                    <h3 class="text-xl font-semibold">PayPal Details</h3>
                                    ${user.paypalDetails ? `
                                        <p><strong>Transaction ID:</strong> ${user.paypalDetails.transactionId || 'N/A'}</p>
                                        ${user.paypalDetails.proofUrl ? `
                                            <p><strong>Proof:</strong> <a href="${user.paypalDetails.proofUrl}" target="_blank" class="text-primary hover:underline">View Proof</a></p>
                                            <img src="${user.paypalDetails.proofUrl}" alt="PayPal Proof" class="w-32 h-32 object-cover rounded-md mt-2">
                                        ` : '<p class="text-muted-foreground">No PayPal proof uploaded.</p>'}
                                        <p><strong>Last Updated:</strong> ${new Date(user.paypalDetails.lastUpdated).toLocaleString()}</p>
                                    ` : '<p class="text-muted-foreground">No PayPal details saved.</p>'}
                                </div>

                                <!-- Crypto Details -->
                                <div class="mt-4">
                                    <h3 class="text-xl font-semibold">Crypto Details</h3>
                                    ${user.cryptoDetails ? `
                                        <p><strong>Transaction ID:</strong> ${user.cryptoDetails.transactionId || 'N/A'}</p>
                                        ${user.cryptoDetails.proofUrl ? `
                                            <p><strong>Proof:</strong> <a href="${user.cryptoDetails.proofUrl}" target="_blank" class="text-primary hover:underline">View Proof</a></p>
                                            <img src="${user.cryptoDetails.proofUrl}" alt="Crypto Proof" class="w-32 h-32 object-cover rounded-md mt-2">
                                        ` : '<p class="text-muted-foreground">No Crypto proof uploaded.</p>'}
                                        <p><strong>Last Updated:</strong> ${new Date(user.cryptoDetails.lastUpdated).toLocaleString()}</p>
                                    ` : '<p class="text-muted-foreground">No Crypto details saved.</p>'}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    detailContainer.innerHTML = '<p class="text-red-500">User not found.</p>';
                }
            } catch (error) {
                console.error("Error loading user details:", error);
                detailContainer.innerHTML = '<p class="text-red-500">Error loading user details.</p>';
            } finally {
                hideLoadingOverlay();
            }
        });
    </script>
</body>
</html>