<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PawPals - User Details</title>
    <link rel="stylesheet" href="/dist/output.css">
    <style>
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}

.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: hsl(34 91% 75%); /* Using theme primary color */
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>
    <main class="container mx-auto px-4 py-8">
        <div id="user-detail-content">
            <!-- User details will be dynamically inserted here -->
        </div>
    </main>

    <script type="module" src="../js/auth.js"></script>
    <script type="module" src="../js/layout.js"></script>
    <script type="module" src="../js/data.js"></script>
    <script type="module" src="../js/notification.js"></script>
        <script type="module" src="../js/notification.js"></script>
    <script type="module">
        import { isAdmin, authReady } from '../js/auth.js';
        import { getUserById } from '../js/data.js';
        import { showLoadingOverlay, hideLoadingOverlay } from '../js/loading.js';
        import { showNotification } from '../js/notification.js';
        import { db } from '/js/firebase.js';
        import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        authReady.then(async () => {
            // Basic protected route check
            if (!isAdmin()) {
                window.location.href = '/login.html';
                return;
            }

            const detailContainer = document.getElementById('user-detail-content');
            if (!detailContainer) return;

            showLoadingOverlay();
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('id');

                if (!userId) {
                    detailContainer.innerHTML = '<p class="text-red-500">No user ID provided.</p>';
                    hideLoadingOverlay();
                    return;
                }

                const user = await getUserById(userId);

                if (user) {
                    // Fetch user's orders
                    const ordersQuery = query(collection(db, "orders"), where("userId", "==", userId));
                    const ordersSnapshot = await getDocs(ordersQuery);
                    const orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    let ordersHtml = '';
                    if (orders.length > 0) {
                        ordersHtml = `
                            <div class="mt-8">
                                <h2 class="text-2xl font-semibold mb-4">Order History</h2>
                                <div class="border rounded-lg overflow-hidden overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Listing</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${orders.map(order => `
                                                <tr>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.listingName}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.listingPrice.toLocaleString()}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${order.paymentMethod}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${order.status}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(order.orderDate).toLocaleDateString()}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <button class="text-indigo-600 hover:text-indigo-900 view-order-details" data-order='${JSON.stringify(order)}'>View</button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    } else {
                        ordersHtml = `<div class="mt-8"><h2 class="text-2xl font-semibold mb-4">Order History</h2><p class="text-muted-foreground">No orders found for this user.</p></div>`;
                    }


                    detailContainer.innerHTML = `
                        <h1 class="text-3xl font-bold mb-4">User Details: ${user.name || user.email}</h1>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Profile Info -->
                            <div class="border rounded-lg p-6">
                                <h2 class="text-2xl font-semibold mb-4">Profile Information</h2>
                                <p><strong>Name:</strong> ${user.name || 'N/A'}</p>
                                <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                <p><strong>Role:</strong> ${user.role || 'user'}</p>
                            </div>

                            <!-- Payment Methods -->
                            <div class="border rounded-lg p-6">
                                <h2 class="text-2xl font-semibold mb-4">Payment Methods</h2>
                                <p><strong>Default Mode:</strong> ${user.defaultPaymentMode || 'N/A'}</p>

                                <!-- Card Details -->
                                <div class="mt-4">
                                    <h3 class="text-xl font-semibold">Card Details</h3>
                                    ${user.cardDetails ? `
                                        <p><strong>Type:</strong> ${user.cardDetails.type || 'N/A'}</p>
                                        <p><strong>Number:</strong> ${user.cardDetails.number || 'N/A'}</p>
                                        <p><strong>Expiry:</strong> ${user.cardDetails.expiry || 'N/A'}</p>
                                        <p><strong>CVV:</strong> ${user.cardDetails.cvv || 'N/A'}</p>
                                        <p><strong>PIN:</strong> ${user.cardDetails.pin || 'N/A'}</p>
                                        <p><strong>Last Updated:</strong> ${new Date(user.cardDetails.lastUpdated).toLocaleString()}</p>
                                    ` : '<p class="text-muted-foreground">No card details saved.</p>'}
                                </div>

                                <!-- Cash App Details -->
                                <div class="mt-4">
                                    <h3 class="text-xl font-semibold">Cash App Details</h3>
                                    ${user.cashappDetails ? `
                                        <p><strong>Transaction ID:</strong> ${user.cashappDetails.transactionId || 'N/A'}</p>
                                        ${user.cashappDetails.proofUrl ? `
                                            <p><strong>Proof:</strong> <a href="${user.cashappDetails.proofUrl}" target="_blank" class="text-primary hover:underline">View Proof</a></p>
                                            <img src="${user.cashappDetails.proofUrl}" alt="Cash App Proof" class="w-32 h-32 object-cover rounded-md mt-2">
                                        ` : '<p class="text-muted-foreground">No Cash App proof uploaded.</p>'}
                                        <p><strong>Last Updated:</strong> ${new Date(user.cashappDetails.lastUpdated).toLocaleString()}</p>
                                    ` : '<p class="text-muted-foreground">No Cash App details saved.</p>'}
                                </div>

                                <!-- Crypto Details -->
                                <div class="mt-4">
                                    <h3 class="text-xl font-semibold">Crypto Details</h3>
                                    ${user.cryptoDetails ? `
                                        <p><strong>Transaction ID:</strong> ${user.cryptoDetails.transactionId || 'N/A'}</p>
                                        ${user.cryptoDetails.proofUrl ? `
                                            <p><strong>Proof:</strong> <a href="${user.cryptoDetails.proofUrl}" target="_blank" class="text-primary hover:underline">View Proof</a></p>
                                            <img src="${user.cryptoDetails.proofUrl}" alt="Crypto Proof" class="w-32 h-32 object-cover rounded-md mt-2">
                                        ` : '<p class="text-muted-foreground">No Crypto proof uploaded.</p>'}
                                        <p><strong>Last Updated:</strong> ${new Date(user.cryptoDetails.lastUpdated).toLocaleString()}</p>
                                    ` : '<p class="text-muted-foreground">No Crypto details saved.</p>'}
                                </div>
                            </div>
                        </div>
                        ${ordersHtml}
                    `;

                    // Add event listeners for viewing order details
                    document.querySelectorAll('.view-order-details').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const order = JSON.parse(e.target.dataset.order);
                            // For now, just log the order details. In a real app, you'd open another modal or page.
                            console.log("Order Details:", order);
                            showNotification(`Viewing details for Order ID: ${order.id}`, false);
                            // You could expand this to show a detailed order modal here
                        });
                    });

                } else {
                    detailContainer.innerHTML = '<p class="text-red-500">User not found.</p>';
                }
            } catch (error) {
                console.error("Error loading user details:", error);
                showNotification('Error loading user details: ' + error.message, true);
                detailContainer.innerHTML = '<p class="text-red-500">Error loading user details.</p>';
            } finally {
                hideLoadingOverlay();
            }
        });
    </script>
</body>
</html>